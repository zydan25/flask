{% extends "base.html" %}

{% block title %}الرسائل - بوت واتساب{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-comments"></i> جميع الرسائل
                    </h4>
                    <div>
                        <button class="btn btn-outline-danger" onclick="clearMessages()">
                            <i class="fas fa-trash"></i> حذف الكل
                        </button>
                        <button class="btn btn-primary" onclick="loadMessages()">
                            <i class="fas fa-sync"></i> تحديث
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- فلاتر البحث -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <input type="text" class="form-control" id="search-input" placeholder="بحث في الرسائل...">
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <select class="form-select" id="type-filter">
                    <option value="">جميع الأنواع</option>
                    <option value="chat">نصية</option>
                    <option value="image">صور</option>
                    <option value="video">فيديو</option>
                    <option value="audio">صوت</option>
                    <option value="document">مستندات</option>
                </select>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <select class="form-select" id="group-filter">
                    <option value="">الكل</option>
                    <option value="false">فردية</option>
                    <option value="true">مجموعات</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- قائمة الرسائل -->
<div id="messages-container">
    <div class="text-center py-5">
        <div class="loading"></div>
        <p class="mt-3">جاري تحميل الرسائل...</p>
    </div>
</div>

<!-- عداد الرسائل -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <p class="mb-0">
                    عرض <strong id="messages-count">0</strong> رسالة
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Modal لعرض تفاصيل الرسالة -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-comment"></i> تفاصيل الرسالة
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="message-details">
                <!-- سيتم ملؤه بـ JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allMessages = [];
    let filteredMessages = [];
    
    // رسالة جديدة من Socket.IO
    socket.on('new_message', function(message) {
        allMessages.unshift(message);
        applyFilters();
    });
    
    // تحميل الرسائل
    function loadMessages() {
        fetch('/api/messages?limit=100')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allMessages = data.data.reverse();
                    applyFilters();
                }
            })
            .catch(error => {
                console.error('خطأ في تحميل الرسائل:', error);
                showError('فشل تحميل الرسائل');
            });
    }
    
    // تطبيق الفلاتر
    function applyFilters() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const typeFilter = document.getElementById('type-filter').value;
        const groupFilter = document.getElementById('group-filter').value;
        
        filteredMessages = allMessages.filter(msg => {
            // بحث نصي
            if (searchTerm) {
                const body = (msg.body || '').toLowerCase();
                const from = (msg.from || '').toLowerCase();
                const contactName = (msg.contactName || '').toLowerCase();
                
                if (!body.includes(searchTerm) && 
                    !from.includes(searchTerm) && 
                    !contactName.includes(searchTerm)) {
                    return false;
                }
            }
            
            // فلتر النوع
            if (typeFilter && msg.type !== typeFilter) {
                return false;
            }
            
            // فلتر المجموعات
            if (groupFilter) {
                const isGroup = groupFilter === 'true';
                if (msg.isGroup !== isGroup) {
                    return false;
                }
            }
            
            return true;
        });
        
        displayMessages();
    }
    
    // عرض الرسائل
    function displayMessages() {
        const container = document.getElementById('messages-container');
        const countElement = document.getElementById('messages-count');
        
        if (filteredMessages.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-inbox fa-4x mb-3"></i>
                    <p>لا توجد رسائل</p>
                </div>
            `;
            countElement.textContent = '0';
            return;
        }
        
        container.innerHTML = '';
        countElement.textContent = filteredMessages.length;
        
        filteredMessages.forEach(message => {
            const messageCard = createMessageCard(message);
            container.appendChild(messageCard);
        });
    }
    
    // إنشاء بطاقة رسالة
    function createMessageCard(message) {
        const div = document.createElement('div');
        div.className = 'message-card card mb-3';
        
        const typeIcon = getTypeIcon(message.type);
        const timestamp = formatDateTime(message.timestamp);
        
        div.innerHTML = `
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="d-flex align-items-start mb-2">
                            <div class="me-3">
                                <i class="${typeIcon} fa-2x text-primary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${message.contactName || 'غير معروف'}
                                    ${message.isGroup ? '<span class="badge bg-info"><i class="fas fa-users"></i> مجموعة</span>' : ''}
                                </h6>
                                <small class="text-muted">${message.from}</small>
                            </div>
                        </div>
                        <p class="mb-2">${escapeHtml(message.body || 'لا يوجد نص')}</p>
                        ${message.hasMedia ? `
                            <span class="badge bg-success">
                                <i class="fas fa-paperclip"></i> ${message.mediaType || 'ملف مرفق'}
                            </span>
                        ` : ''}
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted d-block mb-2">
                            <i class="fas fa-clock"></i> ${timestamp}
                        </small>
                        <button class="btn btn-sm btn-outline-primary" onclick='showMessageDetails(${JSON.stringify(message).replace(/'/g, "&apos;")})'>
                            <i class="fas fa-eye"></i> عرض التفاصيل
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        return div;
    }
    
    // عرض تفاصيل الرسالة
    function showMessageDetails(message) {
        const modal = new bootstrap.Modal(document.getElementById('messageModal'));
        const content = document.getElementById('message-details');
        
        const timestamp = formatDateTime(message.timestamp);
        
        content.innerHTML = `
            <table class="table">
                <tr>
                    <th>المرسل:</th>
                    <td>${message.contactName || 'غير معروف'}</td>
                </tr>
                <tr>
                    <th>الرقم:</th>
                    <td>${message.from}</td>
                </tr>
                <tr>
                    <th>النوع:</th>
                    <td>${message.type}</td>
                </tr>
                <tr>
                    <th>الوقت:</th>
                    <td>${timestamp}</td>
                </tr>
                <tr>
                    <th>مجموعة:</th>
                    <td>${message.isGroup ? 'نعم' : 'لا'}</td>
                </tr>
                <tr>
                    <th>الرسالة:</th>
                    <td>${escapeHtml(message.body || 'لا يوجد نص')}</td>
                </tr>
                ${message.hasMedia ? `
                    <tr>
                        <th>نوع الملف:</th>
                        <td>${message.mediaType || 'غير محدد'}</td>
                    </tr>
                    ${message.mediaData ? `
                        <tr>
                            <th>المعاينة:</th>
                            <td>
                                ${message.mediaType && message.mediaType.startsWith('image/') ? 
                                    `<img src="data:${message.mediaType};base64,${message.mediaData}" class="img-fluid" style="max-width: 100%;">` 
                                    : '<span class="text-muted">غير متاح</span>'}
                            </td>
                        </tr>
                    ` : ''}
                ` : ''}
            </table>
        `;
        
        modal.show();
    }
    
    // حذف جميع الرسائل
    function clearMessages() {
        if (!confirm('هل أنت متأكد من حذف جميع الرسائل؟')) {
            return;
        }
        
        fetch('/api/clear-messages', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allMessages = [];
                    filteredMessages = [];
                    displayMessages();
                    alert('تم حذف جميع الرسائل');
                }
            })
            .catch(error => {
                console.error('خطأ:', error);
                alert('فشل حذف الرسائل');
            });
    }
    
    // وظائف مساعدة
    function getTypeIcon(type) {
        const icons = {
            'chat': 'fas fa-comment',
            'image': 'fas fa-image',
            'video': 'fas fa-video',
            'audio': 'fas fa-music',
            'document': 'fas fa-file',
            'ptt': 'fas fa-microphone',
            'sticker': 'fas fa-smile'
        };
        return icons[type] || 'fas fa-comment';
    }
    
    function formatDateTime(timestamp) {
        const date = new Date(timestamp * 1000);
        return date.toLocaleString('ar-SA', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showError(message) {
        const container = document.getElementById('messages-container');
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> ${message}
            </div>
        `;
    }
    
    // Event Listeners
    document.getElementById('search-input').addEventListener('input', applyFilters);
    document.getElementById('type-filter').addEventListener('change', applyFilters);
    document.getElementById('group-filter').addEventListener('change', applyFilters);
    
    // تحميل البيانات الأولية
    loadMessages();
</script>
{% endblock %}
