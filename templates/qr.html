{% extends "base.html" %}

{% block title %}QR Code - بوت واتساب{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-body text-center">
                <h4 class="card-title mb-4">
                    <i class="fas fa-qrcode"></i> رمز QR للاتصال
                </h4>
                <hr>
                
                <div id="qr-container">
                    <div class="py-5">
                        <div class="loading mb-3" style="margin: 0 auto;"></div>
                        <p class="text-muted">جاري التحميل...</p>
                    </div>
                </div>
                
                <div id="qr-instructions" class="mt-4" style="display: none;">
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle"></i> كيفية الاتصال:</h5>
                        <ol class="text-end me-4">
                            <li>افتح واتساب على هاتفك</li>
                            <li>اذهب إلى <strong>الإعدادات</strong> أو <strong>القائمة</strong></li>
                            <li>اضغط على <strong>الأجهزة المرتبطة</strong></li>
                            <li>اضغط على <strong>ربط جهاز</strong></li>
                            <li>وجّه كاميرا هاتفك نحو هذا الرمز</li>
                        </ol>
                    </div>
                </div>
                
                <button class="btn btn-primary mt-3" onclick="refreshQR()">
                    <i class="fas fa-sync"></i> تحديث
                </button>
            </div>
        </div>
    </div>
</div>

<!-- سجل QR Codes السابقة -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-history"></i> سجل الاتصالات
                </h5>
                <hr>
                <div id="qr-history">
                    <p class="text-muted text-center">لا يوجد سجل</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    #qr-container img {
        max-width: 350px;
        border: 3px solid #667eea;
        border-radius: 15px;
        padding: 15px;
        background: white;
        box-shadow: 0 5px 25px rgba(102, 126, 234, 0.3);
    }
    
    .qr-expired {
        opacity: 0.5;
        filter: grayscale(100%);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .qr-appear {
        animation: fadeIn 0.5s ease-in-out;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let qrCheckInterval = null;
    
    // تحديث QR من Socket.IO
    socket.on('qr_update', function(data) {
        displayQR(data.qrImage, data.timestamp);
    });
    
    // تحديث الحالة
    socket.on('status_update', function(status) {
        if (status.status === 'ready') {
            showConnected();
        } else if (status.status !== 'qr') {
            showWaiting();
        }
    });
    
    // تحميل QR
    function loadQR() {
        fetch('/api/qr')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.qrImage) {
                    displayQR(data.data.qrImage, data.data.timestamp);
                } else {
                    checkBotStatus();
                }
            })
            .catch(error => {
                console.error('خطأ في تحميل QR:', error);
                showError('فشل تحميل QR Code');
            });
    }
    
    // عرض QR
    function displayQR(qrImage, timestamp) {
        const container = document.getElementById('qr-container');
        const instructions = document.getElementById('qr-instructions');
        
        container.innerHTML = `
            <div class="qr-appear">
                <img src="${qrImage}" alt="QR Code" class="img-fluid mb-3">
                <p class="text-muted">
                    <i class="fas fa-clock"></i> 
                    تم الإنشاء: ${formatTimestamp(timestamp)}
                </p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>تنبيه:</strong> هذا الرمز صالح لفترة محدودة فقط
                </div>
            </div>
        `;
        
        instructions.style.display = 'block';
        
        // بدء التحقق الدوري من الحالة
        startStatusCheck();
    }
    
    // التحقق من حالة البوت
    function checkBotStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const status = data.data;
                    
                    if (status.status === 'ready') {
                        showConnected();
                    } else if (status.status === 'qr' && status.hasQR) {
                        loadQR();
                    } else {
                        showWaiting();
                    }
                }
            });
    }
    
    // عرض رسالة الاتصال
    function showConnected() {
        const container = document.getElementById('qr-container');
        const instructions = document.getElementById('qr-instructions');
        
        container.innerHTML = `
            <div class="py-5">
                <i class="fas fa-check-circle fa-5x text-success mb-3"></i>
                <h4 class="text-success">متصل بنجاح!</h4>
                <p class="text-muted">البوت الآن متصل وجاهز لإرسال واستقبال الرسائل</p>
            </div>
        `;
        
        instructions.style.display = 'none';
        stopStatusCheck();
    }
    
    // عرض رسالة الانتظار
    function showWaiting() {
        const container = document.getElementById('qr-container');
        const instructions = document.getElementById('qr-instructions');
        
        container.innerHTML = `
            <div class="py-5">
                <i class="fas fa-hourglass-half fa-4x text-warning mb-3 pulse"></i>
                <h4 class="text-muted">في انتظار QR Code</h4>
                <p class="text-muted">يرجى الانتظار حتى يتم إنشاء رمز QR جديد</p>
                <button class="btn btn-primary mt-3" onclick="requestNewQR()">
                    <i class="fas fa-sync"></i> طلب QR جديد
                </button>
            </div>
        `;
        
        instructions.style.display = 'none';
    }
    
    // عرض رسالة خطأ
    function showError(message) {
        const container = document.getElementById('qr-container');
        
        container.innerHTML = `
            <div class="py-5">
                <i class="fas fa-exclamation-circle fa-4x text-danger mb-3"></i>
                <h4 class="text-danger">خطأ</h4>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary mt-3" onclick="loadQR()">
                    <i class="fas fa-redo"></i> إعادة المحاولة
                </button>
            </div>
        `;
    }
    
    // تحديث QR
    function refreshQR() {
        loadQR();
    }
    
    // طلب QR جديد
    function requestNewQR() {
        alert('يرجى إعادة تشغيل البوت أو تسجيل الخروج للحصول على QR جديد');
    }
    
    // بدء التحقق الدوري
    function startStatusCheck() {
        stopStatusCheck(); // إيقاف أي فحص سابق
        
        qrCheckInterval = setInterval(() => {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.status === 'ready') {
                        showConnected();
                    }
                });
        }, 5000); // كل 5 ثواني
    }
    
    // إيقاف التحقق الدوري
    function stopStatusCheck() {
        if (qrCheckInterval) {
            clearInterval(qrCheckInterval);
            qrCheckInterval = null;
        }
    }
    
    // تنسيق الوقت
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'غير متاح';
        
        const date = new Date(timestamp);
        return date.toLocaleString('ar-SA', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    
    // تحميل البيانات الأولية
    checkBotStatus();
    
    // تنظيف عند مغادرة الصفحة
    window.addEventListener('beforeunload', () => {
        stopStatusCheck();
    });
</script>
{% endblock %}
